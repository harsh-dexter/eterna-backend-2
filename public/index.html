<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Execution Engine</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <header>
        <h1>DEX Order Router</h1>
        <div style="color: #8b949e; font-size: 12px;">v1.0.0</div>
    </header>
    
    <div class="controls">
        <div class="form-group">
            <label for="inputToken">Input Token</label>
            <input type="text" id="inputToken" value="SOL" placeholder="e.g. SOL">
        </div>
        <div class="form-group">
            <label for="outputToken">Output Token</label>
            <input type="text" id="outputToken" value="USDC" placeholder="e.g. USDC">
        </div>
        <div class="form-group">
            <label for="amount">Amount</label>
            <input type="number" id="amount" value="1.5" step="0.1" placeholder="0.00">
        </div>
        <button id="submitBtn" onclick="submitOrder()">
            Execute Order
        </button>
        <button class="secondary" onclick="simulateTraffic()">
            Simulate 5 Orders
        </button>
    </div>

    <div id="orders-list">
        <!-- Orders will appear here -->
    </div>
</div>

<script>
    async function submitOrder(customAmount) {
        const input_token = document.getElementById('inputToken').value;
        const output_token = document.getElementById('outputToken').value;
        const amount = customAmount || parseFloat(document.getElementById('amount').value);

        if (!input_token || !output_token || !amount) return;

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input_token, output_token, amount })
            });

            const data = await response.json();

            if (response.ok) {
                createOrderCard(data.orderId, input_token, output_token, amount, data.status);
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }

        } catch (e) {
            console.error(e);
            alert('Network error');
        }
    }

    function simulateTraffic() {
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                const amt = (Math.random() * 10 + 1).toFixed(2);
                submitOrder(parseFloat(amt));
            }, i * 200);
        }
    }

    function createOrderCard(orderId, inToken, outToken, amount, initialStatus) {
        const list = document.getElementById('orders-list');
        
        const card = document.createElement('div');
        card.className = 'order-card';
        card.id = `card-${orderId}`;
        
        // New Grid Layout
        card.innerHTML = `
            <div class="order-info-group">
                <div class="order-main-text">${amount} ${inToken} âž” ${outToken}</div>
                <div class="order-sub-text">Market Order</div>
            </div>
            <div class="order-info-group">
                <div class="order-sub-text" title="${orderId}">ID: ${orderId.substring(0, 12)}...</div>
                <div class="order-sub-text" id="time-${orderId}">${new Date().toLocaleTimeString()}</div>
            </div>
            <div class="status-badge" id="status-${orderId}">${initialStatus}</div>
            <div class="logs-area" id="logs-${orderId}"></div>
        `;

        list.appendChild(card);
        updateStatusColor(initialStatus, document.getElementById(`status-${orderId}`));

        // Connect WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/api/orders/${orderId}`);

        ws.onopen = () => addLog(orderId, 'Connected to stream...');
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.status) {
                const badge = document.getElementById(`status-${orderId}`);
                if (badge) {
                    badge.innerText = data.status;
                    updateStatusColor(data.status, badge);
                }
            }
            
            if (data.message) {
                addLog(orderId, `[${data.status}] ${data.message}`);
            }

            if (data.status === 'CONFIRMED' || data.status === 'FAILED') {
                ws.close();
            }
        };
    }

    function addLog(orderId, msg) {
        const logsDiv = document.getElementById(`logs-${orderId}`);
        if (!logsDiv) return;
        const div = document.createElement('div');
        div.className = 'log-line';
        div.innerText = msg;
        logsDiv.appendChild(div);
        logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function updateStatusColor(status, element) {
        if (!element) return;
        
        let color = '#8b949e'; // Default gray

        switch(status) {
            case 'PENDING': color = '#d29922'; break; // Yellow/Orange
            case 'ROUTING': color = '#58a6ff'; break; // Blue
            case 'BUILDING': color = '#db61a2'; break; // Pink
            case 'SUBMITTED': color = '#a371f7'; break; // Purple
            case 'CONFIRMED': color = '#238636'; break; // Green
            case 'FAILED': color = '#f85149'; break; // Red
        }
        
        element.style.color = color;
        element.style.border = `1px solid ${color}`;
        element.style.backgroundColor = 'transparent'; // Outline style
    }
</script>

</body>
</html>
